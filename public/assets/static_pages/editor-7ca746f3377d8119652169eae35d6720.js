(function(e){function t(e){var t=e;return t=t.replace(/&/g,"&amp;"),t=t.replace(/"/g,"&quote;"),t=t.replace(/\\/g,"&#39;"),t=t.replace(/</g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/ /g,"&nbsp;")}var n=function(){this.KEY={Backspace:8,Enter:13,Delete:46,LeftArrow:37,RightArrow:39,UpArrow:38,DownArrow:40},this.$element=e('<textarea class="text-input"></textarea>'),this.$element.on("textInput",this.onTextInput.bind(this)),this.$element.on("keydown",this.onKeyDown.bind(this))};(function(){this.onTextInput=function(){var t=this;setTimeout(function(){e(t).trigger("textInput",t.$element.val()),t.$element.val("")},0)},this.focus=function(){this.$element.focus()},this.onKeyDown=function(t){t.keyCode==this.KEY.Backspace?e(this).trigger("backspacePressed"):t.keyCode==this.KEY.Enter?e(this).trigger("enterPressed"):t.keyCode==this.KEY.Delete?e(this).trigger("deletePressed"):t.keyCode==this.KEY.UpArrow?e(this).trigger("upArrowPressed"):t.keyCode==this.KEY.DownArrow?e(this).trigger("downArrowPressed"):t.keyCode==this.KEY.LeftArrow?e(this).trigger("leftArrowPressed"):t.keyCode==this.KEY.RightArrow&&e(this).trigger("rightArrowPressed")}}).call(n.prototype);var i=function(){this.$element=e('<div class="cursor"></div>'),this._activate()};(function(){this._activate=function(){var e=this;this.blinkId=setInterval(function(){e.$element.css("visibility","hidden"),setTimeout(function(){e.$element.css("visibility","visible")},400)},1e3)},this.moveTo=function(e){this.$element.css("top",e.y),this.$element.css("left",e.x)}}).call(i.prototype);var r=function(){this.$element=e('<div class="cursor-layer"></div>'),this.cursor=new i,this.$element.append(this.cursor.$element),this.$element.on("click",this.onClick.bind(this))};(function(){this.onClick=function(t){var n=t.clientX-this.$element.offset().left,i=t.clientY-this.$element.offset().top;e(this).trigger("click",[n,i]),console.log("coordinates clicked:"),console.log("x: "+n+" y: "+i)},this.moveCursorTo=function(e){this.cursor.moveTo(e)}}).call(r.prototype);var s=function(){this.charWidthTable=[]};(function(){this._measureCharWidth=function(n){var i=0,r=e('<div class="measure-node"></div>');return e(document.body).append(r),r.html(t(n)),i=r.width(),r.text(""),i},this.getCharWidth=function(e){if(void 0==this.charWidthTable[e]){var t=this._measureCharWidth(e);return this.charWidthTable[e]=t,t}return this.charWidthTable[e]},this.splitIntoLines=function(e,t){var n=[],i=0;n[i]={content:"",length:0};var r="",s=0,o=0,h=0,a=e.length;for(var l in e){var p=this.getCharWidth(e[l]);" "==e[l]?(t>=h+o+p?(n[i].content+=r+" ",n[i].length+=s+1,h+=o+p):(t>=o&&o+p>t?(n[i].content=r,n[i].length=s,n[i+1]={content:" ",length:1},h=p):(n[i+1]={content:r+" ",length:s+1},h=o+p),i+=1),r="",s=0,o=0):t>=o&&o+p>t?(n[i].content=r,n[i].length=s,n[i+1]={content:"",length:0},i+=1,h=0,r=e[l],s=1,o=p,l==a-1&&(n[i].content=e[l],n[i].length=1)):(r+=e[l],s+=1,o+=p,l==a-1&&(t>=h+o?(n[i].content+=r,n[i].length+=s):n[i+1]={content:r,length:s}))}return console.log("lines:"),console.log(n),n}}).call(s.prototype);var o=function(t){this.$element=e('<div class="lineview"></div>'),this.$element.css("height",t.lineHeight),this.properties=t,this.content="",this.length=0};(function(){this.insertText=function(e,t){var n={};if(0>t|t>this.content.length)throw"Insert position out of range.";var i=this.content.substring(0,t)+e+this.content.substring(t),r=this.properties.charRepository.splitIntoLines(i,this.properties.width);if(this.content=r[0].content,this.length=r[0].length,this.render(),r.length>1){for(var s="",o=1;r.length>o;o++)s+=r[o].content;n={exceeded:!0,extra:s}}else n={exceeded:!1};return n},this.getText=function(e,t){if(0>e)throw"start position out of range.";if(t>this.length)throw"end position out of range.";if(e>t)throw"start position is after the end position.";return this.content.slice(e,t)},this.deleteText=function(e,t){if(0>e)throw"start position out of range.";if(t>this.length)throw"end position out of range.";if(e>t)throw"start position is after the end position.";this.content=this.content.substring(0,e)+this.content.substring(t),this.length-=t-e,this.render()},this.getPixelPosition=function(e){for(var t=0,n=0;e>n;n++){var i=this.properties.charRepository.getCharWidth(this.content[n]);t+=i}return t},this.getPosition=function(e){var t=0,n=0;for(var i in this.content){var r=this.properties.charRepository.getCharWidth(this.content[i]);if(!(e>=n+r)){e-n>n+r-e&&(n+=r,t+=1);break}n+=r,t+=1}return t},this.getPositionAfter=function(e,t){return e+t>this.length?{exceeded:!0,remainingSteps:e+t-this.length}:{exceeded:!1,position:e+t}},this.render=function(){this.$element.html(t(this.content))}}).call(o.prototype);var h=function(t){this.$element=e('<div class="paragraphview"></div>'),this.lines=[],this.properties=t,this.appendLine(new o(this.properties)),this.charCount=0};(function(){this.appendLine=function(e){this.lines.push(e),this.$element.append(e.$element)},this._removeLines=function(e,t){for(var n=e;t>=n;n++)this.lines[n].$element.remove();this.lines.splice(e,t-e+1)},this.insertText=function(e,t){this.charCount+=e.length,this._insertTextRecursively(e,t)},this._insertTextRecursively=function(e,t){var n=this.lines[t.lineIndex],i=n.insertText(e,t.charIndex);if(i.exceeded){if(t.lineIndex==this.lines.length-1){var r=new o(this.properties);this.appendLine(r)}this._insertTextRecursively(i.extra,{lineIndex:t.lineIndex+1,charIndex:0})}},this.deleteText=function(e,t){if(!(e.lineIndex<=t.lineIndex))throw"start position is after end position.";var n=this.getText(t,this.getLastPosition()),i=this.lines[e.lineIndex];i.deleteText(e.charIndex,i.length),this._removeLines(e.lineIndex+1,this.lines.length-1),this.insertText(n,e)},this.getText=function(e,t){var n="";if(e.lineIndex==t.lineIndex)return this.lines[e.lineIndex].getText(e.charIndex,t.charIndex);if(e.lineIndex<t.lineIndex){var i=this.lines[e.lineIndex];n+=i.getText(e.charIndex,i.length);for(var r=e.lineIndex+1;t.lineIndex>r;r++)n+=this.lines[r].content;var s=this.lines[t.lineIndex];return n+=s.getText(0,t.charIndex)}throw"start position is after end position."},this.getPixelPosition=function(e){for(var t=0,n=0;e.lineIndex>n;n++)t+=this.properties.lineHeight;var i=this.lines[e.lineIndex].getPixelPosition(e.charIndex);return{x:i,y:t}},this.getPosition=function(e){var t={x:e.x,y:e.y},n=Math.min(Math.floor(t.y/this.properties.lineHeight),this.lines.length-1),i=this.lines[n].getPosition(t.x);return{lineIndex:n,charIndex:i}},this.getPreviousPosition=function(e){if(e.charIndex>0)return{lineIndex:e.lineIndex,charIndex:e.charIndex-1};if(0==e.charIndex){if(e.lineIndex>0)return{lineIndex:e.lineIndex-1,charIndex:this.lines[e.lineIndex-1].length-1};if(0==e.lineIndex)return null;throw"Line index out of range"}throw"Char index out of range."},this.getLastPosition=function(){var e=this.lines.length-1;return{lineIndex:e,charIndex:this.lines[e].length}},this.getPositionAfter=function(e,t){for(var n=e.charIndex,i=t,r=e.lineIndex;this.lines.length>r;r++){var s=this.lines[r].getPositionAfter(n,i);if(!s.exceeded)return{lineIndex:r,charIndex:s.position};n=0,i=s.remainingSteps}throw"end position is out of range."},this.isEmpty=function(){return this.lines[0].content.length>0?!1:!0}}).call(h.prototype);var a=function(t){this.$element=e('<div class="text-layer"></div>'),this.properties=t,this.paragraphs=[],this.appendParagraph(new h(this.properties))};(function(){this.appendParagraph=function(e){this.paragraphs.push(e),this.$element.append(e.$element)},this.insertText=function(e,t){var n=this.paragraphs.length;if(t.paragraphIndex!=n||this.paragraphs[n-1].isEmpty()||this.appendParagraph(new h(this.properties)),!(t.paragraphIndex<this.paragraphs.length))throw"paragraph index is out of range.";var i=this.paragraphs[t.paragraphIndex];i.insertText(e,{lineIndex:t.lineIndex,charIndex:t.charIndex})},this.deleteText=function(e,t){if(0>e.paragraphIndex)throw"start paragraph index is not valid.";if(t.paragraphIndex>=this.paragraphs.length)throw"end paragraph index is not valid.";if(e.paragraphIndex>t.paragraphIndex)throw"Start position is after the end position.";if(e.paragraphIndex==t.paragraphIndex)this.paragraphs[e.paragraphIndex].deleteText({lineIndex:e.lineIndex,charIndex:e.charIndex},{lineIndex:t.lineIndex,charIndex:t.charIndex});else{var n=this.paragraphs[e.paragraphIndex];n.deleteText({lineIndex:e.lineIndex,charIndex:e.charIndex},n.getLastPosition());var i=this.paragraphs[t.paragraphIndex];i.deleteText({lineIndex:0,charIndex:0},{lineIndex:t.lineIndex,charIndex:t.charIndex}),this._removeParagraphs(e.paragraphIndex+1,t.paragraphIndex-1)}},this._removeParagraphs=function(e,t){for(var n=e;t>=n;n++)this.paragraphs[n].$element.remove();this.paragraphs.splice(e,t-e+1)},this.getPixelPosition=function(e){for(var t=0,n=0;e.paragraphIndex>n;n++)t+=this.paragraphs[n].getHeight();var i=this.paragraphs[e.paragraphIndex].getPixelPosition({lineIndex:e.lineIndex,charIndex:e.charIndex});return{x:i.x,y:t+i.y}},this.getPosition=function(e){var t=0,n=0,i={x:e.x,y:e.y};if(i.y>0)for(var r=0;this.paragraphs.length>r;r++){var s=this.paragraphs[r].$element.height();if(!(e.y>n))break;t=r,i.y=e.y-n,n+=s}var o=this.paragraphs[t].getPosition(i);return{paragraphIndex:t,lineIndex:o.lineIndex,charIndex:o.charIndex}},this.getPreviousPosition=function(e){if(e.paragraphIndex>=0){var t=this.paragraphs[e.paragraphIndex].getPreviousPosition({lineIndex:e.lineIndex,charIndex:e.charIndex});if(null!=t)return{paragraphIndex:e.paragraphIndex,lineIndex:t.lineIndex,charIndex:t.charIndex};if(e.paragraphIndex>1){var n=this.paragraphs[e.paragraphIndex-1].getLastPosition();return{paragraphIndex:e.paragraphIndex-1,lineIndex:n.lineIndex,charIndex:n.charIndex}}return null}throw"Paragraph index out of range."},this.getPositionAfter=function(e,t){var n=this.paragraphs[e.paragraphIndex].getPositionAfter({lineIndex:e.lineIndex,charIndex:e.charIndex},t);return{paragraphIndex:e.paragraphIndex,lineIndex:n.lineIndex,charIndex:n.charIndex}},this.splitParagraph=function(){}}).call(a.prototype);var l=function(t){this.$element=e(t),this.properties={},this.properties.charRepository=new s,this.properties.width=this.$element.width(),this.properties.lineHeight=30,this.caretPosition={paragraphIndex:0,lineIndex:0,charIndex:0},this.textLayer=new a(this.properties),this.cursorLayer=new r,this.textInput=new n,this.$element.append(this.textInput.$element),this.$element.append(this.cursorLayer.$element),this.$element.append(this.textLayer.$element),this.focus(),e(this.textInput).on("textInput",this.onTextInput.bind(this)),e(this.cursorLayer).on("click",this.onClick.bind(this)),e(this.textInput).on("backspacePressed",this.onBackspacePressed.bind(this)),e(this.textInput).on("enterPressed",this.onEnterPressed.bind(this))};(function(){this.onTextInput=function(e,t){this.textLayer.insertText(t,this.caretPosition),this.caretPosition=this.textLayer.getPositionAfter(this.caretPosition,t.length),console.log("current position:"),console.log(this.caretPosition);var n=this.textLayer.getPixelPosition(this.caretPosition);this.cursorLayer.moveCursorTo(n)},this.focus=function(){this.textInput.focus()},this.onClick=function(e,t,n){this.focus();var i=this.textLayer.getPosition({x:t,y:n});this.caretPosition=i;var r=this.textLayer.getPixelPosition(i);this.cursorLayer.moveCursorTo(r),console.log("position clicked:"),console.log(i)},this.onBackspacePressed=function(){var e=this.textLayer.getPreviousPosition(this.caretPosition);if(null!=e){this.textLayer.deleteText(e,this.caretPosition),console.log("current position:"),console.log(e),this.caretPosition=e;var t=this.textLayer.getPixelPosition(e);this.cursorLayer.moveCursorTo(t)}},this.onEnterPressed=function(){this.textLayer.splitParagraph(this.caretPosition)}}).call(l.prototype),e.fn.editor=function(t){return this.each(function(){var n=e(this),i=n.data("editor"),r="object"==typeof t&&t;i||n.data("editor",i=new l(this,r))})},e.fn.editor.Constructor=l,window.CharRepository=s,window.Line=o,window.Paragraph=h,window.TextLayer=a})(window.jQuery),$(document).ready(function(){$("div.editor").editor()});